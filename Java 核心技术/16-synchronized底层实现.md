[toc]

## 16 | synchronized 底层实现

### 问题

-   **synchronized 底层如何实现？什么是锁的升级、降级？**

### 回答

1.  synchronized 代码块是由一对儿 **monitorenter/monitorexit** 指令实现。

2.  Java 6 前，Monitor 实现依靠操作系统内的**互斥锁**，需要用户态/内核态的切换，**重量级**。

3.  现代（Oracle）JDK，提供了三种不同的 Monitor 实现：**偏斜锁、轻量级锁和重量级锁**。

4.  **升级、降级**，JVM 检测到不同的竞争状况时，自动切换到适合的锁实现。

    >   a. 没有竞争时，**默认**使用**偏斜锁**。
    >
    >   b. 如果有另外的线程试图锁定某个已经被偏斜过的对象，JVM 就需要撤销（revoke）偏斜锁，并切换到**轻量级锁**的实现。
    >
    >   c. 轻量级锁依赖 CAS 操作 Mark Word 来试图获取锁，如果重试成功，就使用普通的轻量级锁。否则，进一步升级为**重量级锁**。
    >
    >   
    >
    >   d. 当 JVM 进入安全点（SafePoint）时，会检查是否有闲置的 Monitor，然后试图进行**降级**。 

### 分析

### 扩展

