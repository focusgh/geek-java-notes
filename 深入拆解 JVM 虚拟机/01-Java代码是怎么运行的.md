[toc]

## 01 | Java 代码是怎么运行的？

1.  问题
    -   为什么 Java 要在虚拟机中运行呢？
    -   Java 虚拟机具体又是怎么运行 Java 代码的呢，它的运行效率如何呢？
2.  通过这几个问题，一起探讨下，Java 执行系统的主流实现以及设计决策。

### 为什么 Java 要在虚拟机里运行？

1.  **跨平台**，“一次编写，到处运行”
2.  **托管环境**（Managed Runtime）
    -   自动内在管理
    -   垃圾回收
    -   ……

### Java 虚拟机具体是怎么运行 Java 字节码的？

1.  将 class 文件加载到 JVM。加载后，Java 类被存放于**方法区**（Method Area）中。
2.  JVM 在内存中划分出**堆和栈**来存储运行时数据。
    -   **栈**细分为 Java 方法栈、本地方法栈、PC 寄存器。
3.  蓝图
    -   ![img](imgs/ab5c3523af08e0bf2f689c1d6033ef77.png)
4.  运行过程中
    -   调用一个 Java 方法，Java 虚拟机会在当前线程的 Java 方法栈中生成一个栈帧，存放局部变量及字节码的操作数。
    -   退出方法时，弹出栈帧。
5.  HotSpot 里，翻译过程有两种形式
    -   解释执行
    -   即时编译（JIT）
    -   ![img](imgs/5ee351091464de78eed75438b6f9183b.png)

### Java 虚拟机是运行效率究竟是怎么样的？

1.  HotSpot 中即时编译建立在程序符合的二八定律的假设上。
2.  理论上，即时编译后的 Java 程序的执行效率，是可能超过 C++ 程序的。
3.  即时编译器
    -   C1，Client 编译器
    -   C2，Server 编译器
    -   Graal
        -   Java 10 正式引入的实验性即时编译器。

4.  从 Java 7 开始，HotSpot 默认采用**分层编译**的方式：
    -   热点首先会被 C1 编译，而后热点方法中的热点会进一步被 C2 编译。
    -   编译线程的 CPU 占用比，1:2（C1:C2）。

### 小结

1.  为何在虚拟机中运行
    -   可移植性
    -   代码托管环境
2.  如何在虚拟机中运行
    -   运行时内在区域划分为五个部分：
        -   方法区
        -   堆
        -   PC 寄存器
        -   Java 方法栈
        -   本地方法栈
3.  提高运行效率
    -   HotSpot 虚拟机采用一种混合执行策略
        -   解释执行 Java 字节码.
        -   将热点代码，以方法为单位进行即时编译，翻译成机器码。



